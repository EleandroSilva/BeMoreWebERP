unit Model.Conexao.Impl.Firedac.MySQL;

interface

uses
  System.SysUtils,
  System.Classes,
  System.Types,

  FireDAC.Stan.Intf,
  FireDAC.Stan.Option,
  FireDAC.Stan.Error,
  FireDAC.UI.Intf,
  FireDAC.Phys.Intf,
  FireDAC.Stan.Def,
  FireDAC.Stan.Pool,
  FireDAC.Stan.Async,
  FireDAC.Phys,
  FireDAC.Phys.MySQL,
  FireDAC.Phys.MySQLDef,
  FireDAC.VCLUI.Wait,
  FireDAC.Comp.Client,
  FireDAC.Stan.Param,
  FireDAC.DatS,
  FireDAC.DApt.Intf,
  FireDAC.DApt,
  FireDAC.Comp.DataSet,

  Data.DB,

  Model.Conexao.Interfaces,

  Model.Conexao.Configuracao.Interfaces,
  Model.Conexao.Impl.Configuracao;

type
  TConexaoFiredacMySQL = class(TInterfacedObject, iConexao)
    private
      FConexao      : TFDConnection;
      FDriverMySQL  : TFDPhysMySQLDriverLink;
      FConfiguracao : iConfiguracao;

      function VendorLib : String;
    public
      constructor Create;
      destructor Destroy; override;
      class function New: iConexao;

      function Connection : TCustomConnection;
  end;

implementation

{ TClassePadrao }

constructor TConexaoFiredacMySQL.Create;
begin
  FConexao      := TFDConnection.Create(nil);
  FDriverMySQL  := TFDPhysMySQLDriverLink.Create(nil);
  FConfiguracao := TConfiguracao.New;
end;

destructor TConexaoFiredacMySQL.Destroy;
begin
  FreeAndNil(FConexao);
  FreeAndNil(FDriverMySQL);
  inherited;
end;

class function TConexaoFiredacMySQL.New: iConexao;
begin
  Result := Self.Create;
end;

function TConexaoFiredacMySQL.Connection: TCustomConnection;
begin
  try
    FDriverMySQL.VendorLib      := VendorLib;

    FConexao.Params.DriverID    := FConfiguracao.DriverID;
    FConexao.Params.Database    := FConfiguracao.Database;
    FConexao.Params.UserName    := FConfiguracao.UserName;
    FConexao.Params.Password    := FConfiguracao.Password;
    FConexao.Params.Add('Port='  + FConfiguracao.Port);
    FConexao.Params.Add('Server='+ FConfiguracao.ServerHost);

    if not FConfiguracao.LibraryName.IsEmpty then
      FConexao.Params.Add('LibraryName='+ FConfiguracao.LibraryName);
    if not FConfiguracao.VendorHome.IsEmpty then
      FConexao.Params.Add('VendorHome='+ FConfiguracao.VendorHome);

    if not FConfiguracao.Schema.IsEmpty then
    begin
      FConexao.Params.Add('MetaCurSchema='+FConfiguracao.Schema);
      FConexao.Params.Add('MetaDefSchema='+FConfiguracao.Schema);
    end;

    if not FConfiguracao.Locking.IsEmpty then
      FConexao.Params.Add('LockingModel='+FConfiguracao.Locking);

    FConexao.LoginPrompt := False;
    FConexao.Connected   := True;
    Result               := FConexao;
  Except
    raise Exception.Create('Não foi possível realizar a conexão!');
  end;
end;

function TConexaoFiredacMySQL.VendorLib: String;
var
  lFile: TFileStream;
  lResource: TResourceStream;
begin
  Result := ExtractFilePath(ParamStr(0))+'libmysql.dll';
  if not FileExists(Result) then
  begin
    try
      lResource := TResourceStream.Create(HInstance, 'libmysql', RT_RCDATA);
      lFile := TFileStream.Create(Result,fmCreate);
      lResource.SaveToStream(lFile);
    finally
      lFile.Free;
      lResource.Free;
    end;
  end;
end;

end.
